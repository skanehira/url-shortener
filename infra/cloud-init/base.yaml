#cloud-config
package_update: true
package_upgrade: false
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - software-properties-common
write_files:
  - path: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
  - path: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
  - path: /etc/crictl.yaml
    content: |
      runtime-endpoint: unix:///run/containerd/containerd.sock
      image-endpoint: unix:///run/containerd/containerd.sock
      timeout: 10
  - path: /etc/logrotate.d/k8s-setup
    content: |
      /var/log/k8s-setup.log /var/log/k8s-cluster-init.log {
        daily
        rotate 7
        compress
        delaycompress
        missingok
        notifempty
      }
  - path: /usr/local/bin/k8s-log.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      # Common logging functions for k8s setup scripts

      log_info() {
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] INFO: $*"
      }

      log_error() {
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $*" >&2
      }

      log_warn() {
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] WARN: $*"
      }
  - path: /usr/local/bin/k8s-common.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      # Versions
      CONTAINERD_VERSION="2.1.2"
      RUNC_VERSION="1.2.6"
      CNI_VERSION="1.6.2"
      K8S_VERSION="1.32"

      # For checksum verification, see release pages:
      # - runc: https://github.com/opencontainers/runc/releases
      # - containerd: https://github.com/containerd/containerd/releases

      LOG_FILE="/var/log/k8s-setup.log"
      exec > >(tee -a "$LOG_FILE") 2>&1

      # Source common logging functions
      source /usr/local/bin/k8s-log.sh

      log_info "Starting Kubernetes setup..."
      log_info "Versions: containerd=${CONTAINERD_VERSION}, runc=${RUNC_VERSION}, cni=${CNI_VERSION}, k8s=${K8S_VERSION}"

      log_info "Disabling swap..."
      swapoff -a || true
      sed -i '/swap/d' /etc/fstab

      log_info "Loading kernel modules..."
      modprobe overlay
      modprobe br_netfilter

      log_info "Applying sysctl parameters..."
      sysctl --system

      ARCH=$(dpkg --print-architecture)

      # Install runc (with idempotency check)
      if [[ -x /usr/local/sbin/runc ]] && /usr/local/sbin/runc --version 2>/dev/null | grep -q "${RUNC_VERSION}"; then
        log_info "runc ${RUNC_VERSION} is already installed, skipping..."
      else
        log_info "Installing runc ${RUNC_VERSION}..."
        if ! curl -fsSL -o /tmp/runc "https://github.com/opencontainers/runc/releases/download/v${RUNC_VERSION}/runc.${ARCH}"; then
          log_error "Failed to download runc"
          exit 1
        fi
        mv /tmp/runc /usr/local/sbin/runc
        chmod 755 /usr/local/sbin/runc
      fi

      # Install containerd (with idempotency check)
      if command -v containerd &>/dev/null && containerd --version 2>/dev/null | grep -q "${CONTAINERD_VERSION}"; then
        log_info "containerd ${CONTAINERD_VERSION} is already installed, skipping..."
      else
        log_info "Installing containerd ${CONTAINERD_VERSION}..."
        if ! curl -fsSL -o /tmp/containerd.tar.gz "https://github.com/containerd/containerd/releases/download/v${CONTAINERD_VERSION}/containerd-${CONTAINERD_VERSION}-linux-${ARCH}.tar.gz"; then
          log_error "Failed to download containerd"
          exit 1
        fi
        tar -xzf /tmp/containerd.tar.gz -C /usr/local
        rm -f /tmp/containerd.tar.gz
      fi

      # Install CNI plugins (with idempotency check)
      if [[ -d /opt/cni/bin ]] && [[ -x /opt/cni/bin/bridge ]]; then
        log_info "CNI plugins appear to be installed, skipping..."
      else
        log_info "Installing CNI plugins ${CNI_VERSION}..."
        mkdir -p /opt/cni/bin
        if ! curl -fsSL "https://github.com/containernetworking/plugins/releases/download/v${CNI_VERSION}/cni-plugins-linux-${ARCH}-v${CNI_VERSION}.tgz" | tar -xz -C /opt/cni/bin; then
          log_error "Failed to install CNI plugins"
          exit 1
        fi
      fi

      # Setup containerd systemd service
      log_info "Setting up containerd systemd service..."
      mkdir -p /usr/local/lib/systemd/system
      if ! curl -fsSL -o /usr/local/lib/systemd/system/containerd.service \
        "https://raw.githubusercontent.com/containerd/containerd/v${CONTAINERD_VERSION}/containerd.service"; then
        log_error "Failed to download containerd.service"
        exit 1
      fi

      log_info "Configuring containerd..."
      mkdir -p /etc/containerd
      containerd config default | sed 's/SystemdCgroup = false/SystemdCgroup = true/' >/etc/containerd/config.toml
      systemctl daemon-reload
      systemctl enable --now containerd

      log_info "Setting up Kubernetes repository..."
      mkdir -p /etc/apt/keyrings
      if ! curl -fsSL "https://pkgs.k8s.io/core:/stable:/v${K8S_VERSION}/deb/Release.key" | gpg --dearmor --batch --yes -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg; then
        log_error "Failed to download Kubernetes GPG key"
        exit 1
      fi
      chmod 0644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg

      cat >/etc/apt/sources.list.d/kubernetes.list <<EOF
      deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v${K8S_VERSION}/deb/ /
      EOF
      sed -i 's/^[[:space:]]*//' /etc/apt/sources.list.d/kubernetes.list

      log_info "Updating package lists..."
      if ! apt-get update; then
        log_error "Failed to update package lists"
        exit 1
      fi

      log_info "Installing kubelet and kubeadm..."
      if ! apt-get install -y kubelet kubeadm; then
        log_error "Failed to install Kubernetes packages"
        exit 1
      fi

      log_info "Holding kubelet and kubeadm packages..."
      apt-mark hold kubelet kubeadm

      log_info "Enabling kubelet service..."
      systemctl enable kubelet

      log_info "Kubernetes setup completed successfully!"
      log_info "Log file: $LOG_FILE"
