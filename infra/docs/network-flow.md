# Kubernetes ネットワーク通信フロー

オンプレ Kubernetes 環境における通信フローを段階的に解説します。

## 目次

1. [MetalLB なしの場合](#1-metallb-なしの場合)
2. [MetalLB ありの場合](#2-metallb-ありの場合)
3. [MetalLB + Gateway API の場合](#3-metallb--gateway-api-の場合)
4. [MetalLB + Gateway API + CoreDNS の場合](#4-metallb--gateway-api--coredns-の場合)

---

## 1. MetalLB なしの場合

MetalLB がない場合、外部からクラスタ内の Pod にアクセスする方法は限られます。

### 1.1 NodePort を使用

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  Service タイプ: NodePort                                                    │
│  外部からは「ノードIP:NodePort」でアクセス                                   │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────┐
│  Client  │
└────┬─────┘
     │
     │ ① HTTP Request
     │    http://192.168.2.10:30080
     │    （ノードIP + NodePort）
     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Kubernetes Cluster                             │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Node 1 (192.168.2.10)                                              │   │
│   │                                                                     │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │  kube-proxy (iptables/IPVS)                                 │    │   │
│   │  │                                                             │    │   │
│   │  │  ② NodePort 30080 へのトラフィックを検知                    │    │   │
│   │  │  ③ Service の Endpoints（Pod IP リスト）を取得              │    │   │
│   │  │  ④ いずれかの Pod に転送（ラウンドロビン）                  │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   │                              │                                      │   │
│   └──────────────────────────────┼──────────────────────────────────────┘   │
│                                  │                                          │
│   ┌──────────────────────────────┼──────────────────────────────────────┐   │
│   │                              ▼                                      │   │
│   │  ┌───────────┐    ┌───────────┐    ┌───────────┐                   │   │
│   │  │   Pod 1   │    │   Pod 2   │    │   Pod 3   │                   │   │
│   │  │10.244.1.10│    │10.244.2.20│    │10.244.3.30│                   │   │
│   │  └───────────┘    └───────────┘    └───────────┘                   │   │
│   │                                                                     │   │
│   │  ⑤ Pod がリクエストを処理し、レスポンスを返す                      │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

問題点:
- ノードIP を直接指定する必要がある
- ノードが落ちたら別のノードIPに切り替えが必要
- ポート番号が 30000-32767 の範囲に制限
- クライアント側で冗長構成を組む必要がある
```

### 1.2 LoadBalancer を使用（オンプレでは Pending のまま）

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  Service タイプ: LoadBalancer                                                │
│  オンプレでは EXTERNAL-IP が割り当てられない                                 │
└──────────────────────────────────────────────────────────────────────────────┘

$ kubectl get svc
NAME         TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)
my-service   LoadBalancer   10.96.100.50   <pending>     80:30080/TCP
                                           ↑
                                           永遠に pending

理由:
- LoadBalancer タイプはクラウドプロバイダーの LB 連携機能を前提
- AWS ELB、GCP Cloud Load Balancer などが IP を払い出す
- オンプレには「IP を払い出すコントローラー」が存在しない
```

---

## 2. MetalLB ありの場合

MetalLB がオンプレ環境で LoadBalancer タイプの Service を実現します。

### 2.1 MetalLB の構成要素

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              MetalLB 構成                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  IPAddressPool                                                      │    │
│  │  - 払い出し可能な IP 範囲を定義                                     │    │
│  │  - 例: 192.168.2.200 - 192.168.2.250                                │    │
│  │  - ノード IP とは別の範囲を使用                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  L2Advertisement                                                    │    │
│  │  - L2 モード（ARP）で IP を広告                                     │    │
│  │  - 各ノードで Speaker Pod が動作                                    │    │
│  │  - リーダー選出された Speaker が ARP 応答                           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ノード IP:    192.168.2.10, 192.168.2.11, 192.168.2.12                    │
│  MetalLB IP:   192.168.2.200, 192.168.2.201, ...                           │
│                ↑                                                            │
│                仮想 IP（VIP）- 実際のノードには割り当てられていない         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 通信フロー（L2 モード）

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  Service タイプ: LoadBalancer + MetalLB                                      │
│  外部からは「MetalLB が払い出した VIP」でアクセス                            │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────┐
│  Client  │
└────┬─────┘
     │
     │ ① ARP Request: 192.168.2.200 の MAC アドレスは？
     │    （クライアントは IP に対応する MAC を知りたい）
     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Kubernetes Cluster                             │
│                                                                             │
│   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐                │
│   │   Node 1    │      │   Node 2    │      │   Node 3    │                │
│   │192.168.2.10 │      │192.168.2.11 │      │192.168.2.12 │                │
│   │             │      │             │      │             │                │
│   │ ┌─────────┐ │      │ ┌─────────┐ │      │ ┌─────────┐ │                │
│   │ │ MetalLB │ │      │ │ MetalLB │ │      │ │ MetalLB │ │                │
│   │ │ Speaker │ │      │ │ Speaker │ │      │ │ Speaker │ │                │
│   │ │(Leader) │◄┼──────┼─┼─────────┼─┼──────┼─┤         │ │                │
│   │ └────┬────┘ │      │ └─────────┘ │      │ └─────────┘ │                │
│   │      │      │      │             │      │             │                │
│   │ ② ARP Reply│      │             │      │             │                │
│   │ "192.168.2.│      │             │      │             │                │
│   │  200 は    │      │             │      │             │                │
│   │  私の MAC" │      │             │      │             │                │
│   └──────┼──────┘      └─────────────┘      └─────────────┘                │
│          │                                                                  │
└──────────┼──────────────────────────────────────────────────────────────────┘
           │
     ┌─────┴─────┐
     │  Client   │
     │ ARP Table │
     │ 192.168.2.│
     │ 200 = MAC │
     │ of Node 1 │
     └─────┬─────┘
           │
           │ ③ HTTP Request to 192.168.2.200
           │    （実際には Node 1 の MAC 宛に送信）
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Kubernetes Cluster                             │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Node 1 (192.168.2.10)                                              │   │
│   │                                                                     │   │
│   │  ④ パケット受信（宛先 IP: 192.168.2.200）                          │   │
│   │                                                                     │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │  kube-proxy (iptables/IPVS)                                 │    │   │
│   │  │                                                             │    │   │
│   │  │  ⑤ 192.168.2.200:80 → Service の Endpoints へ NAT          │    │   │
│   │  │  ⑥ Pod IP リストから選択（ラウンドロビン）                  │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   │                              │                                      │   │
│   └──────────────────────────────┼──────────────────────────────────────┘   │
│                                  │                                          │
│                                  │ ⑦ Pod へ転送（別ノードの Pod も可）     │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │  ┌───────────┐    ┌───────────┐    ┌───────────┐                   │   │
│   │  │   Pod 1   │    │   Pod 2   │    │   Pod 3   │                   │   │
│   │  │  Node 1   │    │  Node 2   │    │  Node 3   │                   │   │
│   │  │10.244.1.10│    │10.244.2.20│    │10.244.3.30│                   │   │
│   │  └───────────┘    └───────────┘    └───────────┘                   │   │
│   │                                                                     │   │
│   │  ⑧ Pod がリクエストを処理し、レスポンスを返す                      │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

利点:
- 固定の VIP でアクセス可能
- ノード障害時は別ノードの Speaker がリーダーになり ARP 応答を引き継ぐ
- クライアントは VIP を知っていればよい
```

---

## 3. MetalLB + Gateway API の場合

1つの IP で複数のサービスをホスト名ベースでルーティングします。

### 3.1 構成図

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  MetalLB + Gateway API 構成                                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  MetalLB                                                               │  │
│  │  - NGINX Gateway Fabric の Service (LoadBalancer) に VIP を割り当て    │  │
│  │  - 192.168.2.200 → nginx-gateway                                       │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  Gateway API (NGINX Gateway Fabric)                                    │  │
│  │  - Gateway: リスナー定義（ポート、プロトコル）                         │  │
│  │  - HTTPRoute: ホスト名ベースのルーティング                             │  │
│  │  - 1つの IP で複数サービスを公開                                       │  │
│  │                                                                        │  │
│  │  192.168.2.200                                                         │  │
│  │       │                                                                │  │
│  │       ├─ HTTPRoute: app1.example.com → app1-service                    │  │
│  │       ├─ HTTPRoute: app2.example.com → app2-service                    │  │
│  │       └─ HTTPRoute: app3.example.com → app3-service                    │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 通信フロー

```
┌──────────┐
│  Client  │
└────┬─────┘
     │
     │ ① HTTP Request
     │    GET / HTTP/1.1
     │    Host: staging.example.com    ← ホスト名を指定
     │    → 192.168.2.200:80
     │
     │    ※ クライアントは事前に staging.example.com = 192.168.2.200 を
     │       何らかの方法で知っている必要がある（/etc/hosts など）
     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Kubernetes Cluster                             │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  MetalLB Speaker (Node 1 - Leader)                                  │   │
│   │                                                                     │   │
│   │  ② 192.168.2.200 宛のパケットを受信                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  kube-proxy                                                         │   │
│   │                                                                     │   │
│   │  ③ 192.168.2.200:80 → nginx-gateway Pod へ NAT                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  NGINX Gateway Fabric Pod                                           │   │
│   │                                                                     │   │
│   │  ④ HTTP ヘッダーの Host を確認: "staging.example.com"              │   │
│   │                                                                     │   │
│   │  ⑤ Gateway + HTTPRoute リソースを参照                              │   │
│   │     ┌─────────────────────────────────────────────────────────┐     │   │
│   │     │  Gateway: shortener-gateway                              │     │   │
│   │     │  listeners:                                             │     │   │
│   │     │    - name: http                                         │     │   │
│   │     │      port: 80                                           │     │   │
│   │     │      protocol: HTTP                                     │     │   │
│   │     │                                                         │     │   │
│   │     │  HTTPRoute: shortener-service                           │     │   │
│   │     │  hostnames:                                             │     │   │
│   │     │    - staging.example.com                                │     │   │
│   │     │  rules:                                                 │     │   │
│   │     │    - backendRefs:                                       │     │   │
│   │     │        - name: shortener-service                        │     │   │
│   │     │          port: 80                                       │     │   │
│   │     └─────────────────────────────────────────────────────────┘     │   │
│   │                                                                     │   │
│   │  ⑥ shortener-service の Endpoints を取得                           │   │
│   │  ⑦ Pod に直接転送（NGINX がリバースプロキシ）                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  shortener-service Pods                                             │   │
│   │                                                                     │   │
│   │  ┌───────────┐    ┌───────────┐    ┌───────────┐                   │   │
│   │  │   Pod 1   │    │   Pod 2   │    │   Pod 3   │                   │   │
│   │  └───────────┘    └───────────┘    └───────────┘                   │   │
│   │                                                                     │   │
│   │  ⑧ Pod がリクエストを処理                                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ⑨ レスポンスが逆の経路で Client に戻る                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

問題点:
- クライアントが「staging.example.com = 192.168.2.200」を知る方法がない
- /etc/hosts に手動追加が必要
- 複数クライアントがある場合、全員が設定する必要がある
```

---

## 4. MetalLB + Gateway API + CoreDNS の場合

CoreDNS で名前解決を提供し、クライアントはホスト名だけでアクセス可能になります。

### 4.1 構成図

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  完全な構成                                                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │  CoreDNS (kube-system)                                               │    │
│  │  - k8s.local ゾーンを管理                                            │    │
│  │  - url-shortener.staging.k8s.local → 192.168.2.200                   │    │
│  │  - url-shortener.prod.k8s.local    → 192.168.2.200                   │    │
│  │  - NodePort 30053 で外部公開                                         │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                              │                                               │
│                              ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │  MetalLB                                                             │    │
│  │  - 192.168.2.200 を NGINX Gateway Fabric に割り当て                  │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                              │                                               │
│                              ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │  Gateway API (NGINX Gateway Fabric)                                  │    │
│  │  - Gateway: リスナー定義                                             │    │
│  │  - HTTPRoute: ホスト名ベースのルーティング                           │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                              │                                               │
│                              ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │  Application Pods                                                    │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 クライアント設定

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  Mac クライアント設定                                                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  /etc/resolver/k8s.local:                                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  nameserver 192.168.2.10    # k8s-master VM の IP                     │  │
│  │  port 30053                 # CoreDNS の NodePort                     │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  効果:                                                                       │
│  - *.k8s.local の DNS クエリは 192.168.2.10:30053 に送信                    │
│  - その他のドメインは通常の DNS を使用                                       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 完全な通信フロー

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  curl http://url-shortener.staging.k8s.local                                 │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────┐
│  Client  │
│  (Mac)   │
└────┬─────┘
     │
     │ ① DNS Query: url-shortener.staging.k8s.local の A レコードは？
     │    → /etc/resolver/k8s.local の設定に従い
     │    → 192.168.2.10:30053 (k8s-master) に送信
     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Kubernetes Cluster                             │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Node 1 (k8s-master) - 192.168.2.10                                 │   │
│   │                                                                     │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │  kube-proxy                                                 │    │   │
│   │  │  NodePort 30053 → CoreDNS Pod へ転送                        │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   │                              │                                      │   │
│   │                              ▼                                      │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │  CoreDNS Pod (kube-system)                                  │    │   │
│   │  │                                                             │    │   │
│   │  │  Corefile:                                                  │    │   │
│   │  │  ┌─────────────────────────────────────────────────────┐    │    │   │
│   │  │  │  k8s.local:53 {                                     │    │    │   │
│   │  │  │      hosts {                                        │    │    │   │
│   │  │  │          192.168.2.200 url-shortener.staging.k8s.   │    │    │   │
│   │  │  │                        local                        │    │    │   │
│   │  │  │          192.168.2.200 url-shortener.prod.k8s.local │    │    │   │
│   │  │  │      }                                              │    │    │   │
│   │  │  │  }                                                  │    │    │   │
│   │  │  └─────────────────────────────────────────────────────┘    │    │   │
│   │  │                                                             │    │   │
│   │  │  ② url-shortener.staging.k8s.local → 192.168.2.200 を返す  │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
     │
     │ ③ DNS Response: url-shortener.staging.k8s.local = 192.168.2.200
     ▼
┌──────────┐
│  Client  │
│  (Mac)   │
└────┬─────┘
     │
     │ ④ HTTP Request
     │    GET / HTTP/1.1
     │    Host: url-shortener.staging.k8s.local
     │    → 192.168.2.200:80
     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Kubernetes Cluster                             │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  MetalLB Speaker (Leader Node)                                      │   │
│   │                                                                     │   │
│   │  ⑤ ARP で 192.168.2.200 を応答済み                                 │   │
│   │  ⑥ 192.168.2.200 宛のパケットを受信                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  kube-proxy                                                         │   │
│   │                                                                     │   │
│   │  ⑦ 192.168.2.200:80 → nginx-gateway Pod へ NAT                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  NGINX Gateway Fabric Pod                                           │   │
│   │                                                                     │   │
│   │  ⑧ HTTP ヘッダーの Host を確認: "url-shortener.staging.k8s.local" │   │
│   │  ⑨ Gateway + HTTPRoute を参照し、backend を特定                    │   │
│   │  ⑩ shortener-service の Endpoints へ直接転送                       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  shortener-service Pods                                             │   │
│   │                                                                     │   │
│   │  ┌───────────┐    ┌───────────┐    ┌───────────┐                   │   │
│   │  │   Pod 1   │    │   Pod 2   │    │   Pod 3   │                   │   │
│   │  └───────────┘    └───────────┘    └───────────┘                   │   │
│   │                                                                     │   │
│   │  ⑪ Pod がリクエストを処理                                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ⑫ レスポンスが逆の経路で Client に戻る                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

---

## 5. kube-proxy から Pod への通信フロー

kube-proxy がどのようにパケットを Pod に転送するかを詳しく解説します。

### 5.1 kube-proxy の役割

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  kube-proxy とは                                                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  - 各ノードで動作する DaemonSet                                              │
│  - Service → Pod への転送ルールを管理                                        │
│  - 実際にパケットを転送するわけではない（ルールを設定するだけ）              │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐     │
│  │  kube-proxy が監視するもの                                          │     │
│  │                                                                     │     │
│  │  ┌─────────────┐     ┌─────────────┐                                │     │
│  │  │   Service   │     │  Endpoints  │                                │     │
│  │  │             │     │  (Pod IPs)  │                                │     │
│  │  │ ClusterIP:  │     │             │                                │     │
│  │  │ 10.96.0.100 │────►│ 10.244.1.10 │                                │     │
│  │  │ Port: 80    │     │ 10.244.2.20 │                                │     │
│  │  │             │     │ 10.244.3.30 │                                │     │
│  │  └─────────────┘     └─────────────┘                                │     │
│  │         │                   │                                       │     │
│  │         └─────────┬─────────┘                                       │     │
│  │                   ▼                                                 │     │
│  │         iptables / IPVS ルールを生成                                │     │
│  └─────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 iptables モードの動作（デフォルト）

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  iptables モード                                                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  kube-proxy が iptables ルールを作成                                         │
│  カーネルの netfilter がパケットを処理                                       │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐     │
│  │  iptables ルールの構造                                              │     │
│  │                                                                     │     │
│  │  PREROUTING → KUBE-SERVICES → KUBE-SVC-XXXX → KUBE-SEP-YYYY        │     │
│  │                                                                     │     │
│  │  KUBE-SERVICES: Service の ClusterIP/Port をマッチ                  │     │
│  │  KUBE-SVC-XXXX: ロードバランシング（確率ベース）                    │     │
│  │  KUBE-SEP-YYYY: 実際の Pod IP への DNAT                             │     │
│  └─────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 パケット変換の詳細フロー

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  パケットがどのように変換されるか                                            │
└──────────────────────────────────────────────────────────────────────────────┘

外部からのパケット（MetalLB 経由）
┌─────────────────────────────────────────────────────────────────────────────┐
│  元のパケット                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Src IP: 192.168.2.50 (Client)                                      │    │
│  │  Dst IP: 192.168.2.200 (MetalLB VIP)                                │    │
│  │  Dst Port: 80                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Node に到着（MetalLB が ARP 応答したノード）                               │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  ① PREROUTING チェーン（パケット受信直後）                           │  │
│  │                                                                       │  │
│  │  iptables -t nat -A PREROUTING -j KUBE-SERVICES                       │  │
│  │                                                                       │  │
│  │  → KUBE-SERVICES チェーンにジャンプ                                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  ② KUBE-SERVICES チェーン                                            │  │
│  │                                                                       │  │
│  │  # LoadBalancer Service のルール                                      │  │
│  │  -A KUBE-SERVICES -d 192.168.2.200/32 -p tcp --dport 80 \            │  │
│  │     -j KUBE-EXT-XXXX                                                  │  │
│  │                                                                       │  │
│  │  → 宛先 IP とポートがマッチ → KUBE-EXT-XXXX へ                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  ③ KUBE-SVC-XXXX チェーン（ロードバランシング）                      │  │
│  │                                                                       │  │
│  │  # 3つの Pod に均等に分散（確率ベース）                               │  │
│  │  -A KUBE-SVC-XXXX -m statistic --mode random                          │  │
│  │     --probability 0.33333 -j KUBE-SEP-AAAA                            │  │
│  │  -A KUBE-SVC-XXXX -m statistic --mode random                          │  │
│  │     --probability 0.50000 -j KUBE-SEP-BBBB                            │  │
│  │  -A KUBE-SVC-XXXX -j KUBE-SEP-CCCC                                    │  │
│  │                                                                       │  │
│  │  → 確率で Pod を選択（例: KUBE-SEP-BBBB が選ばれた）                  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  ④ KUBE-SEP-BBBB チェーン（DNAT 実行）                               │  │
│  │                                                                       │  │
│  │  # 宛先 IP を Pod IP に書き換え                                       │  │
│  │  -A KUBE-SEP-BBBB -p tcp -j DNAT --to-destination 10.244.2.20:8080   │  │
│  │                                                                       │  │
│  │  → パケットの宛先が Pod IP に変換される                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  DNAT 後のパケット                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Src IP: 192.168.2.50 (Client)  ← 変わらない                        │    │
│  │  Dst IP: 10.244.2.20 (Pod IP)   ← 書き換わった！                    │    │
│  │  Dst Port: 8080                 ← ターゲットポートに変換            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ⑤ ルーティング判断                                                        │
│                                                                             │
│  宛先 10.244.2.20 はどこ？                                                  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  ルーティングテーブル（例: Flannel の場合）                          │  │
│  │                                                                       │  │
│  │  10.244.1.0/24 → Node 1 (192.168.2.10)                               │  │
│  │  10.244.2.0/24 → Node 2 (192.168.2.11)  ← マッチ！                   │  │
│  │  10.244.3.0/24 → Node 3 (192.168.2.12)                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  → Node 2 にパケットを転送                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 ノード間のパケット転送（CNI: Flannel の例）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Node 1 (パケット受信ノード)                                                │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Flannel (VXLAN モード)                                              │  │
│  │                                                                       │  │
│  │  元パケット:                                                          │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Src: 192.168.2.50  Dst: 10.244.2.20                            │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                            │                                          │  │
│  │                            ▼                                          │  │
│  │  ⑥ VXLAN カプセル化                                                  │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Outer Header:                                                  │  │  │
│  │  │    Src: 192.168.2.10 (Node 1)                                   │  │  │
│  │  │    Dst: 192.168.2.11 (Node 2)                                   │  │  │
│  │  │  ┌───────────────────────────────────────────────────────────┐  │  │  │
│  │  │  │  Inner (元のパケット):                                    │  │  │  │
│  │  │  │    Src: 192.168.2.50  Dst: 10.244.2.20                    │  │  │  │
│  │  │  └───────────────────────────────────────────────────────────┘  │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 物理ネットワーク経由
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Node 2 (Pod が存在するノード)                                              │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Flannel                                                              │  │
│  │                                                                       │  │
│  │  ⑦ VXLAN デカプセル化                                                │  │
│  │  → Inner パケットを取り出す                                           │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Src: 192.168.2.50  Dst: 10.244.2.20                            │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  ⑧ cni0 ブリッジ                                                     │  │
│  │                                                                       │  │
│  │  10.244.2.20 は cni0 配下の veth に接続された Pod                     │  │
│  │                                                                       │  │
│  │        cni0 (10.244.2.1)                                              │  │
│  │           │                                                           │  │
│  │    ┌──────┼──────┐                                                    │  │
│  │    │      │      │                                                    │  │
│  │  veth1  veth2  veth3                                                  │  │
│  │    │      │      │                                                    │  │
│  │  Pod1   Pod2   Pod3                                                   │  │
│  │         10.244.2.20 ← ここにパケットが届く                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  ⑨ Pod (コンテナ)                                                    │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Network Namespace                                              │  │  │
│  │  │                                                                 │  │  │
│  │  │  eth0: 10.244.2.20                                              │  │  │
│  │  │  ↓                                                              │  │  │
│  │  │  アプリケーション (port 8080)                                   │  │  │
│  │  │  ↓                                                              │  │  │
│  │  │  リクエストを処理してレスポンスを返す                           │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.5 レスポンスの帰り道（conntrack）

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  レスポンスパケットの流れ                                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Pod からのレスポンス:                                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  Src: 10.244.2.20 (Pod)                                                │  │
│  │  Dst: 192.168.2.50 (Client)                                            │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  conntrack (接続追跡)                                                  │  │
│  │                                                                        │  │
│  │  行きのパケットで DNAT したことを覚えている                            │  │
│  │                                                                        │  │
│  │  conntrack テーブル:                                                   │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Original: 192.168.2.50 → 192.168.2.200:80                      │  │  │
│  │  │  Reply:    10.244.2.20:8080 → 192.168.2.50                      │  │  │
│  │  │  DNAT to:  10.244.2.20:8080                                     │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  → 帰りは自動で逆変換（SNAT）                                          │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  逆変換後のパケット                                                    │  │
│  │                                                                        │  │
│  │  Src: 192.168.2.200 (VIP)  ← Pod IP から書き換わった！                 │  │
│  │  Dst: 192.168.2.50 (Client)                                            │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│                              Client に到着                                   │
│                                                                              │
│  Client から見ると:                                                          │
│  「192.168.2.200 にリクエストして 192.168.2.200 から返ってきた」            │
│  → Pod の存在を意識しない                                                    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.6 全体の通信フロー図

```
┌──────────┐
│  Client  │
│192.168.  │
│2.50      │
└────┬─────┘
     │
     │ ① HTTP Request to 192.168.2.200:80
     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Node 1 (MetalLB Leader)                                                    │
│                                                                             │
│  ② iptables DNAT: 192.168.2.200:80 → 10.244.2.20:8080                      │
│  ③ ルーティング: 10.244.2.0/24 は Node 2 へ                                │
│  ④ Flannel VXLAN カプセル化                                                │
│                                                                             │
└──────────────────────────────────────┬──────────────────────────────────────┘
                                       │
                                       │ VXLAN over UDP
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Node 2                                                                     │
│                                                                             │
│  ⑤ Flannel VXLAN デカプセル化                                              │
│  ⑥ cni0 ブリッジ経由で Pod へ                                              │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Pod (10.244.2.20)                                                  │    │
│  │  ⑦ アプリケーションが処理                                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  ⑧ レスポンス送信                                                          │
│                                                                             │
└──────────────────────────────────────┬──────────────────────────────────────┘
                                       │
                                       │ 逆経路
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Node 1                                                                     │
│                                                                             │
│  ⑨ conntrack による逆 NAT: Src 10.244.2.20 → 192.168.2.200                 │
│                                                                             │
└──────────────────────────────────────┬──────────────────────────────────────┘
                                       │
                                       ▼
                                ┌──────────┐
                                │  Client  │
                                └──────────┘
```

---

## まとめ

### 各コンポーネントの役割

| コンポーネント | 役割 | なぜ必要か |
|---------------|------|-----------|
| MetalLB | 仮想 IP (VIP) の払い出し | オンプレで LoadBalancer Service を実現 |
| Gateway API | ホスト名ベースのルーティング | 1つの IP で複数サービスを公開、TLS 終端、高度なルーティング |
| CoreDNS | 名前解決 | クライアントが IP を知らなくてもホスト名でアクセス可能 |

### 構成の段階的進化

```
NodePort のみ
    │
    │ 問題: ノード IP 直指定、ポート番号制限
    ▼
MetalLB 追加
    │
    │ 解決: 固定 VIP でアクセス可能
    │ 問題: サービスごとに IP 消費、ホスト名ルーティング不可
    ▼
Gateway API 追加
    │
    │ 解決: 1つの IP で複数サービス、ホスト名ルーティング
    │       トラフィック分割、ヘッダーベースルーティングも可能
    │ 問題: クライアントが IP を知る方法がない
    ▼
CoreDNS 追加
    │
    │ 解決: ホスト名で自動的に IP を解決
    ▼
完全な構成
```
